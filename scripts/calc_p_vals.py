import json
import logging
import os

import numpy as np
import scipy.stats as stats

logging.basicConfig()
log = logging.getLogger(__name__)
log.setLevel(level=os.environ.get("LOGLEVEL", "INFO"))


def calc_stats(vals_A: np.ndarray, vals_B: np.ndarray) -> None:
    diff = vals_B - vals_A
    diff_mean = np.mean(diff)
    # diff_std = np.std(diff)
    # diff_sem = diff_std / np.sqrt(len(diff))
    # diff_95ci = 1.96 * diff_sem
    diff_95ci_int = stats.t.interval(0.95, len(diff)-1, loc=np.mean(diff), scale=stats.sem(diff))
    diff_95ci = (diff_95ci_int[1] - diff_95ci_int[0]) / 2.0
    log.info(f"1 vs 2 paired t-test mean diff: {diff_mean:.3g}, 95% CI: Â±{diff_95ci:.2g}")
    statistic, p_value = stats.ttest_rel(vals_B, vals_A)
    log.info(f"1 vs 2 paired t-test statistic: {statistic}, p-value: {p_value:.2g}")


if __name__ == "__main__":
    scrapl_no_padam_no_psaga_no_is = ('{'
                                      '"l1_theta": [0.12249950968450113, 0.09221455118348516, 0.12581262617341932, 0.08770664709229617, 0.1300856012009805, 0.11527488957489686, 0.08265658972724788, 0.07753382743366298, 0.09280013148823088, 0.10716415124554783, 0.09558871292298836, 0.08839813475647276, 0.09242322848689168, 0.10099340086021727, 0.07122302896553466, 0.12255409167658894, 0.09148139722885622, 0.0778433146976655, 0.13470310068899582, 0.08486760023140134], '
                                      '"l1_d": [0.19109592851131188, 0.15664215169606668, 0.20067713385628114, 0.14384004786129917, 0.20401070242927918, 0.18630210863005728, 0.12676740918428664, 0.11484085936700142, 0.14492909898681022, 0.1638433370859392, 0.14150536949596096, 0.13597742131640828, 0.14246216560563726, 0.15003263565801803, 0.1085115382748265, 0.18657315666637111, 0.13769341861048048, 0.10319921422389242, 0.20319173605211316, 0.11807495259469551], '
                                      '"l1_s": [0.05390309181905557, 0.027786950250306384, 0.05094811945192272, 0.031573245602269276, 0.056160497809610015, 0.044247671120589735, 0.038545769549185184, 0.040226794298618036, 0.0406711634488836, 0.05048496576566846, 0.04967205803240495, 0.040818847355342636, 0.042384291788743346, 0.05195416618258717, 0.033934519475986843, 0.058535027287660066, 0.045269375606890615, 0.0524874138495614, 0.06621446544604913, 0.051660249069813716], '
                                      '"tvs_x_normed": [0.004541390183148907, 0.005006763680139557, 0.004600792344426736, 0.00518381589325145, 0.005135161388898269, 0.005367824732093141, 0.0045087155315559355, 0.006509229238145053, 0.005654048452852294, 0.00514296302688308, 0.005627477639354766, 0.004992924248217606, 0.005599307996453716, 0.005057006635470315, 0.006103821377037093, 0.004916519402759151, 0.0050615475565427915, 0.005341129623120651, 0.004993614694103599, 0.006637334292754532], '
                                      '"converged_x_vals": [14304, 13536, 12192, 8352, 13440, 13248, 8640, 9600, 11232, 10560, 10080, 12960, 7968, 9600, 6816, 15648, 8736, 7680, 15360, 8160]'
                                      '}')
    scrapl_no_psaga_no_is          = ('{'
                                      '"l1_theta": [0.09665599946052793, 0.07563703531219108, 0.14551694595044656, 0.20547077732701452, 0.07983336693817565, 0.08775561711480537, 0.07074640438921985, 0.06048114958309353, 0.06186012623290857, 0.0772034814280848, 0.07815523541742751, 0.06303367968047816, 0.08409047607452633, 0.06174802107195697, 0.07112933466992066, 0.08657339407551669, 0.11201826987727993, 0.07232109264981358, 0.07905597960756666, 0.07937167632964345], '
                                      '"l1_d": [0.11014242229923121, 0.09422241872356779, 0.08700265519080619, 0.17184935173680702, 0.06893135090508763, 0.10300991131413365, 0.06484972721626678, 0.06384181567738129, 0.07055813879255321, 0.07716793819300585, 0.09622238648514589, 0.07623989110992795, 0.06572316478817689, 0.07842814826196236, 0.09463347879148294, 0.11508048614186621, 0.11189020905763868, 0.07102036788578953, 0.07249112162859205, 0.0880581140518188], '
                                      '"l1_s": [0.08316957542011809, 0.057051652621838304, 0.2040312362294043, 0.23909220243653942, 0.09073538321160497, 0.07250132339615971, 0.07664308084114901, 0.05712048445017103, 0.053162113192581316, 0.07723902502367568, 0.060088085190903716, 0.0498274677703457, 0.10245778724070514, 0.04506789316092764, 0.0476251897071638, 0.05806630236967912, 0.11214633117760377, 0.07362181825503221, 0.08562083734619998, 0.07068523920832137], '

                                      '"tvs_x_normed": [0.006762286624871194, 0.006403184168739244, 0.0066971457726322115, 0.00804877346206922, 0.0068612640321953225, 0.0075170394399901854, 0.006525834846543148, 0.007863436114857904, 0.006786203596275301, 0.007171063494170084, 0.008102042533573694, 0.0072339590644696725, 0.0074657226080307735, 0.006871206419309601, 0.00677960594824981, 0.006987363155931236, 0.0069847027445212005, 0.00596856909513008, 0.006289634186541662, 0.006239148030872456], '
                                      '"converged_x_vals": [6144, 7968, 9120, 9888, 8064, 8160, 6624, 9984, 6816, 6432, 8448, 7008, 9408, 5760, 8640, 6720, 12288, 8832, 6240, 7584]'
                                      '}')
    scrapl_no_is                   = ('{'
                                      '"l1_theta": [0.06293538465134554, 0.06086657316453991, 0.10795762750410261, 0.19559796827454717, 0.07283522356902396, 0.07453168640213624, 0.06367051925870676, 0.06834078063407246, 0.056387757822390486, 0.05329803689833605, 0.057915136338241587, 0.05671606825724719, 0.07411241375150215, 0.0666352532082988, 0.05322176722749582, 0.058576290886248265, 0.08620131472426072, 0.07010723422131226, 0.06727552437974556, 0.06899673119187351], '
                                      '"l1_d": [0.07412058811995287, 0.07021285665612062, 0.0751165592622372, 0.15297372639179227, 0.0689179002036971, 0.07184818314929158, 0.0772050099988137, 0.0691187023635833, 0.0667277909815311, 0.05468951093573719, 0.05415757084565774, 0.06035070289527212, 0.06232824080413383, 0.06707842636012258, 0.05342478617545092, 0.0612049147246345, 0.0641598181138115, 0.07363495579169638, 0.062294469966042376, 0.06888184924760168], '
                                      '"l1_s": [0.05175018058188496, 0.05152028955278853, 0.14079869610648, 0.23822221015730208, 0.07675254765537473, 0.07721519109702875, 0.050136029479965045, 0.06756285830370837, 0.04604772526410314, 0.05190656298110557, 0.06167269990809499, 0.053081433979734256, 0.08589658657869982, 0.06619207969596304, 0.05301874851988204, 0.05594766704786204, 0.10824281265658713, 0.0665795127710988, 0.07225657999515529, 0.06911161181426811], '
                                      '"tvs_x_normed": [0.003406228398089296, 0.003343306191964075, 0.0030973285314394167, 0.0039437007415108385, 0.003209539278177545, 0.0036537065671291215, 0.0032840438798302785, 0.003938616156810896, 0.0033615063386969266, 0.003134258071077056, 0.003916056338348427, 0.003524474699515848, 0.0039705005759606135, 0.0036107588332379235, 0.0038180655124597247, 0.003420287433546036, 0.0035549548821290963, 0.003318965992657467, 0.002683339346549474, 0.0029586990113602955], '
                                      '"converged_x_vals": [6528, 6720, 6912, 9408, 6912, 7968, 6240, 8928, 5568, 6048, 6720, 7296, 8928, 4992, 7776, 5568, 10080, 10848, 6240, 6240]'
                                      '}')
    scrapl                         = ('{'
                                      '"l1_theta": [0.06180974011940336, 0.06289083859132177, 0.06804874863836069, 0.07660534208820707, 0.05656429824809869, 0.05915405408989994, 0.06763846931918971, 0.06726277259088327, 0.06606629863381382, 0.06792472194760073, 0.05683173575708937, 0.05154910611529501, 0.06779285628468755, 0.07373488550224606, 0.09878867552165058, 0.06783113724762391, 0.06141195458269884, 0.0634658455608352, 0.05952812394788184, 0.05869293741641501], '
                                      '"l1_d": [0.0666157788326663, 0.06492859365478636, 0.08528196294942206, 0.10381107801391228, 0.0757758175173113, 0.05433180351411138, 0.07085421429045734, 0.08332478471340668, 0.08438587885710497, 0.08880813155443433, 0.06685573980212207, 0.05502523674118899, 0.05479143475813245, 0.0978055721329104, 0.07614698128834842, 0.07919440778993787, 0.068973800107356, 0.06697338146548112, 0.052510034893789546, 0.05602713494050884], '
                                      '"l1_s": [0.057003701766652405, 0.06085308304717459, 0.050815535048323264, 0.049399607965061695, 0.03735277849820348, 0.06397630478585915, 0.06442272326638618, 0.05120076034818921, 0.04774671768949874, 0.04704131330213235, 0.046807731351544736, 0.048072975729742305, 0.08079427769107199, 0.049664198390899125, 0.12143036891375815, 0.056467867185992546, 0.0538501095387243, 0.059958309896530594, 0.06654621288180346, 0.061358740733515785], '
                                      '"tvs_x_normed": [0.0033364005817566066, 0.003349886837531812, 0.0029958275269018494, 0.0036728850699728356, 0.003288925565429963, 0.0033794242196017884, 0.0029720154323149475, 0.0037422973284265025, 0.003313107471331023, 0.003294972685398534, 0.0037640647165244445, 0.0032979093905305496, 0.0033897824480663996, 0.003317260306794197, 0.0032416041096439583, 0.003012437739525922, 0.003385741148958914, 0.003066016654483974, 0.002724702156265266, 0.002842149349744432], '
                                      '"converged_x_vals": [4800, 5760, 5664, 5952, 5952, 6912, 5472, 7584, 4224, 5664, 5664, 5472, 7008, 4128, 6432, 5280, 10752, 7872, 4800, 4896]'
                                      '}')

    # mult = 1000
    mult = 1
    y_col = "l1_theta"
    # y_col = "l1_d"
    # y_col = "l1_s"
    # y_col = "tvs_x_normed"
    # y_col = "converged_x_vals"

    vals_A = np.array(json.loads(scrapl_no_padam_no_psaga_no_is)[y_col]) * mult
    vals_B = np.array(json.loads(scrapl_no_psaga_no_is)[y_col]) * mult
    calc_stats(vals_A, vals_B)

    vals_A = np.array(json.loads(scrapl_no_psaga_no_is)[y_col]) * mult
    vals_B = np.array(json.loads(scrapl_no_is)[y_col]) * mult
    calc_stats(vals_A, vals_B)

    vals_A = np.array(json.loads(scrapl_no_is)[y_col]) * mult
    vals_B = np.array(json.loads(scrapl)[y_col]) * mult
    calc_stats(vals_A, vals_B)
